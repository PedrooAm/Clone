<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
  <title>AWS IAM Not*</title>


  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- Themify -->
  <link rel="stylesheet" href="themify/themify.css">

  <!-- Critical CSS -->
  
  <link href="/scss/critical.min.css" rel="stylesheet" />

  <!--Favicon-->
  <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
  <link rel="icon" href="images/favicon.png" type="image/x-icon" />
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=%23"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', '#');
  </script>
	
</head>

  <body>
    <nav class="main-nav navbar navbar-expand-lg">
  <div class="container-fluid">
    <!-- Logo -->
    <a class="navbar-brand" href="./">
      <img
        class="logo-main"
        src="images/logo.png"
        alt="Deep Dives"
      />
    </a>
    <!-- Toogle Button -->
    <button
      class="navbar-toggler collapsed"
      type="button"
      data-toggle="collapse"
      data-target="#mainNav"
    >
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <div class="collapse navbar-collapse nav-list" id="mainNav">
      <!-- Navigation Links -->
      
      
      <ul class="navbar-nav ml-auto">
      
        <li class="nav-item">
          <a href="././#hero" class="nav-link ">Home</a>
        </li>
      
        <li class="nav-item">
          <a href="././#feature" class="nav-link ">About</a>
        </li>
      
        <li class="nav-item">
          <a href="./courses" class="nav-link ">Courses</a>
        </li>
      
        <li class="nav-item">
          <a href="././#team" class="nav-link ">Team</a>
        </li>
      
        <li class="nav-item">
          <a href="././#faq" class="nav-link ">FAQ</a>
        </li>
      
        <li class="nav-item">
          <a href="./blog" class="nav-link ">Blog</a>
        </li>
      
      </ul>
      <div class="account-list list-inline">
        <li class="list-inline-item">
          <a href="contact" class="btn btn-sm btn-violate">
            Get in touch
          </a>
        </li>
      </div>
    </div>
  </div>
</nav>

    <div id="content">
      

<section class="page-header blog-single-header">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h2>
          AWS IAM Not*
        </h2>
        <div class="post-meta">
          <ul>
            <li>
              <img src="images/team/johannes.jpeg" alt="author-thumb" />
            </li>
            <li>
              <h5>
                Johannes Verjwijnen
              </h5>
            </li>
            <li>
              January 2, 2021
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="blog-single">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 mx-auto">
        <article class="blog-single-post">
          <p>Sometimes writing <a href="https://aws.amazon.com/iam/">AWS IAM</a> policies gets confusing. Especially if our policy authoring is reactive in nature instead of following a proactive permissions strategy.</p>
<p><img src="https://miro.medium.com/max/4800/1*Ks7GuiPPa2pswNTuITHGSw.png#center" alt="Image courtesy Amazon Web Services IAM User Guide"></p>
<p>Wow — this is complicated! Additionally some of the documentation and courseware suggest doing both allow and deny-statements.</p>
<p>What how?</p>
<p>Well the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_s3_deny-except-bucket.html">Amazon S3: Limits managing to a specific S3 Bucket</a> example in the IAM User Guide shows the idea.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Statement&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Action&#34;</span>: <span style="color:#e6db74">&#34;s3:*&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Resource&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;arn:aws:s3:::bucket-name&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;arn:aws:s3:::bucket-name/*&#34;</span>
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Deny&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;NotAction&#34;</span>: <span style="color:#e6db74">&#34;s3:*&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;NotResource&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;arn:aws:s3:::bucket-name&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;arn:aws:s3:::bucket-name/*&#34;</span>
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>So here we’re allowing all S3 access on to a particular bucket and its contents, and then denying all other actions (for all other services!) and for all other resources.</p>
<p>So how do the NotAction and NotResource -elements work? If we take a look at the policy evaluation order we can see that the second step is “Evaluate all applicable policies”. Thus if a request comes in from a principal that has the above policy attached for reading an item from a DynamoDB table the above policy will be evaluated into a deny.</p>
<ul>
<li>The first part of the policy allows S3-actions, so that would be skipped as not matching the request.</li>
<li>For the second part any DynamoDB-action will match the “NotAction”: “s3:*”-part thus a deny decision is made.</li>
<li>As a deny overrides any possible allows we will deny the request.</li>
</ul>
<p>But wait a minute, wasn’t the policy evaluation logic deny by default anyway? Yes it is, and this kind of policy is only needed if you are feeling that you might (accidentally) give someone permissions they shouldn’t have.</p>
<p>There are more sane ways to use NotAction with Allow to, for example, allow full control except deletion.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;NotAction&#34;</span>: <span style="color:#e6db74">&#34;s3:DeleteBucket&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;Resource&#34;</span>: <span style="color:#e6db74">&#34;arn:aws:s3:::*&#34;</span>,</span></span></code></pre></div>
<p>This is way easier than having to explicitly list all S3-actions. But doesn’t that allow all other services? Would a DynamoDB table read be allowed with this kind of policy? Well no, as the resource in that request would be a DynamoDB-table instead of a S3-bucket.</p>
<p>Similarly we can restrict access to a particular resource by using the Deny-NotResource -pattern.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Deny&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;Action&#34;</span>: <span style="color:#e6db74">&#34;s3:*&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;NotResource&#34;</span>: [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;arn:aws:s3:::OurBucket&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;arn:aws:s3:::OurBucket/*&#34;</span>
</span></span><span style="display:flex;"><span>]</span></span></code></pre></div>
<p>So here we are denying all S3-actions to all resources except one bucket and its contents. Note that this alone will not give access to that particular resource as an explicit allow is required somewhere else.</p>
<p>Combining Allow and NotResource becomes terribly frightening. Think of an innocent-looking policy like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;Action&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;NotResource&#34;</span>: [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;arn:aws:s3:::SecretBucket&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;arn:aws:s3:::SecretBucket/*&#34;</span>
</span></span><span style="display:flex;"><span>]</span></span></code></pre></div>
<p>So we’re probably trying to give full access to S3 except for a particular bucket and its contents here. However, we have just given all possible permissions (except access to that bucket) using this policy. And this doesn’t restrict anything as we also gave the permission to change policies themselves :D</p>
<p>The motivation for this blogpost came from a discussion on what NotAction: * or NotResource: * would do. There is a common misconception that they would invert the Effect which naturally isn’t true.</p>
<p>Remember the way that the evaluation logic works. It would first evaluate all applicable policies, thus any request with any action wouldn’t match the NotAction: *-pattern and any request with any resource wouldn’t match the NotResource: *-pattern. Thus they are practically no-ops.</p>
<p>I tested it (for completeness). Created a user with the inline policy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Statement&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Deny&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Action&#34;</span>: <span style="color:#e6db74">&#34;s3:*&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;NotResource&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>And then tried to list buckets</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">duvin</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">iMac</span> <span style="color:#960050;background-color:#1e0010">~</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">aws</span> <span style="color:#a6e22e">s3</span> <span style="color:#a6e22e">ls</span>  <span style="color:#f92672">--</span><span style="color:#a6e22e">profile</span> <span style="color:#a6e22e">notresource</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">An</span> <span style="color:#66d9ef">error</span> <span style="color:#a6e22e">occurred</span> (<span style="color:#a6e22e">AccessDenied</span>) <span style="color:#a6e22e">when</span> <span style="color:#a6e22e">calling</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">ListBuckets</span> <span style="color:#a6e22e">operation</span>: <span style="color:#a6e22e">Access</span> <span style="color:#a6e22e">Denied</span></span></span></code></pre></div>
<p>As anticipated. If we add an Allow-permission that allow works normally as if the deny wouldn’t exist.</p>

         <a target="_blank" href="https://blog.deepdives.eu/aws-iam-not-3cabe7887531" class="btn btn-primary-filled">Original Source
  </a>      
          </article>
      </div>
    </div>
  </div>
</section>


    </div>
    <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="footer-subscribe-title">
          <h2>Subscribe and Stay Updated</h2>
        </div>
      </div>
      <div class="col-lg-8 mx-auto">
        <form action="#" class="footer-subscribe-form">
          <div class="from-group">
            <div class="input-group">
              <input type="email" class="form-control" placeholder="Enter Your E-mail">
              <div class="subscribe">
                <button class="btn btn-subscribe" type="submit">
                  <span class="btn-area">
                    Subscribe
                  </span>
                  <svg class="icon-left" xmlns="http://www.w3.org/2000/svg" width="16.317" height="15.323"
                    viewBox="0 0 16.317 15.323">
                    <g data-name="Group 1167">
                      <g data-name="Group 1166">
                        <path data-name="Path 1349"
                          d="M.004 5.359a.7.7 0 00.587.693l6.091 1.609L.591 9.27a.7.7 0 00-.587.693v4.656a.7.7 0 00.206.5.726.726 0 00.119.1.7.7 0 00.675.044l14.911-6.958a.7.7 0 000-1.274L1.004.066a.7.7 0 00-1 .637zm13.952 2.3"
                          fill="#fff" />
                      </g>
                    </g>
                  </svg>
                  <svg class="icon-center" xmlns="http://www.w3.org/2000/svg" width="16.317" height="15.323"
                    viewBox="0 0 16.317 15.323">
                    <g data-name="Group 1167">
                      <g data-name="Group 1166">
                        <path data-name="Path 1349"
                          d="M.004 5.359a.7.7 0 00.587.693l6.091 1.609L.591 9.27a.7.7 0 00-.587.693v4.656a.7.7 0 00.206.5.726.726 0 00.119.1.7.7 0 00.675.044l14.911-6.958a.7.7 0 000-1.274L1.004.066a.7.7 0 00-1 .637zm13.952 2.3"
                          fill="#fff" />
                      </g>
                    </g>
                  </svg>
                </button>
              </div>

            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-4 col-md-4">
        <div class="footer-description">
          <img width="250px" src="images/logo-white.png" alt="logo">
          <p>
            All right reserved
              </br>
              Copyright © Deep Dives 2022
          </p>
          <ul class="footer-description-social">
            <li>
              <a href="https://www.facebook.com/pg/#"><i class="ti-facebook"></i></a>
            </li>
            <li>
              <a href="https://twitter.com/#"><i class="ti-twitter-alt"></i></a>
            </li>
            <li>
              <a href=""><i class="ti-github"></i></a>
            </li>
          </ul>
        </div>
      </div>
      <div class="col-lg-4 col-md-4">
        <div class="footer-widget">
          <h4>Sitemap</h4>
          <div class="footer-widget-list">
            <ul>
              
                
                  <li><a href="./">Home</a></li>
              
                  <li><a href="blog">Blog</a></li>
              
                  <li><a href="courses">Courses</a></li>
              
                  <li><a href="privacy">Privacy &amp; Policy</a></li>
              
                  <li><a href="contact">Contact</a></li>
              
            </ul>
          </div>
        </div>
      </div>
      <div class="col-lg-4 col-md-4">
        <div class="footer-widget">
          <h4>Address</h4>
          
          <div class="footer-widget-list">
            <ul>
              <li><a href="mailto:info@deepdives.eu"><i class="ti-email"></i>info@deepdives.eu</a></li>
              <li><p><i class="ti-pin"></i>Deep Dives oy, PO Box 333, 00121 Helsinki, Finland</p></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>


<link href="/scss/non-critical.min.css" rel="stylesheet" />

<script src="/js/vendor.min.js"></script>

<script src="/js/form-handler.min.js"></script>

<script src="/js/script.min.js"></script>
  </body>
</html>
